/*!
 * maptalks.three v0.5.0
 * LICENSE : MIT
 * (c) 2016-2018 maptalks.org
 */
/*!
 * requires maptalks@>=0.36.2 
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("maptalks"),require("three")):"function"==typeof define&&define.amd?define(["exports","maptalks","three"],t):t(e.maptalks=e.maptalks||{},e.maptalks,e.THREE)}(this,function(e,u,l){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):function(e,t){for(var r=Object.getOwnPropertyNames(t),n=0;n<r.length;n++){var o=r[n],a=Object.getOwnPropertyDescriptor(t,o);a&&a.configurable&&void 0===e[o]&&Object.defineProperty(e,o,a)}}(e,t))}var p=Math.PI/180,t=function(e){function t(){return r(this,t),n(this,e.apply(this,arguments))}return o(t,e),t.prototype.draw=function(){this.renderScene()},t.prototype.drawOnInteracting=function(){this.renderScene()},t.prototype.coordinateToVector3=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,r=this.getMap();if(!r)return null;var n=r.coordinateToPoint(e,f(r));return new l.Vector3(n.x,n.y,-t)},t.prototype.distanceToVector3=function(e,t,r){var n=this.getMap(),o=f(n),a=r||n.getCenter(),i=n.locate(a,e,t),s=n.coordinateToPoint(a,o),c=n.coordinateToPoint(i,o),h=Math.abs(c.x-s.x)*u.Util.sign(e),p=Math.abs(c.y-s.y)*u.Util.sign(t);return new l.Vector3(h,p,0)},t.prototype.toShape=function(e){var r=this;if(!e)return null;if(e instanceof u.MultiPolygon)return e.getGeometries().map(function(e){return r.toShape(e)});var t=e.getCenter(),n=this.coordinateToVector3(t),o=e.getShell().map(function(e){return r.coordinateToVector3(e).sub(n)}),a=new l.Shape(o),i=e.getHoles();return i&&0<i.length&&(a.holes=i.map(function(e){var t=e.map(function(e){return r.coordinateToVector3(e).sub(n)});return new l.Shape(t)})),a},t.prototype.toExtrudeMesh=function(e,t,r,n){var o=this;if(!e)return null;if(e instanceof u.MultiPolygon)return e.getGeometries().map(function(e){return o.toExtrudeGeometry(e,t,r)});if(n){var a=e.getCoordinates();a.forEach(function(e){for(var t=e.length-1;1<=t;t--)e[t].equals(e[t-1])&&e.splice(t,1)}),e.setCoordinates(a)}var i=this.toShape(e),s=this.coordinateToVector3(e.getCenter());t=this.distanceToVector3(t,t).x;var c=new l.ExtrudeGeometry(i,{amount:t,bevelEnabled:!0}),h=new l.BufferGeometry;h.fromGeometry(c);var p=new l.Mesh(h,r);return p.position.set(s.x,s.y,-t),p},t.prototype.toMesh=function(e,t,r,n){var o=this;if(!e)return null;if(e instanceof u.MultiPolygon)return e.getGeometries().map(function(e){return o.toExtrudeGeometry(e,t,r)});if(n){var a=e.getCoordinates();a.forEach(function(e){for(var t=e.length-1;1<=t;t--)e[t].equals(e[t-1])&&e.splice(t,1)}),e.setCoordinates(a)}var i=this.toShape(e),s=this.coordinateToVector3(e.getCenter());t=this.distanceToVector3(t,t).x;var c=new l.ExtrudeGeometry(i,{amount:0,bevelEnabled:!0}),h=new l.BufferGeometry;h.fromGeometry(c);var p=new l.Mesh(h,r);return p.position.set(s.x,s.y,-t),p},t.prototype.clearMesh=function(){var e=this.getScene();if(!e)return this;for(var t=e.children.length-1;0<=t;t--)e.children[t]instanceof l.Mesh&&e.remove(e.children[t]);return this},t.prototype.lookAt=function(e){var t=this._getRenderer();return t&&t.context.lookAt(e),this},t.prototype.getCamera=function(){var e=this._getRenderer();return e?e.camera:null},t.prototype.getScene=function(){var e=this._getRenderer();return e?e.scene:null},t.prototype.renderScene=function(){var e=this._getRenderer();return e?e.renderScene():this},t.prototype.getThreeRenderer=function(){var e=this._getRenderer();return e?e.context:null},t.prototype.loop=function(){var e=this.getRenderer();e.clearCanvas(),e._drawLayer()},t.prototype._getFovRatio=function(){var e=this.getMap().getFov();return Math.tan(e/2*p)},t}(u.CanvasLayer);t.mergeOptions({renderer:"gl",doubleBuffer:!0,glOptions:null});var a=function(e){function t(){return r(this,t),n(this,e.apply(this,arguments))}return o(t,e),t.prototype.getPrepareParams=function(){return[this.scene,this.camera]},t.prototype.getDrawParams=function(){return[this.scene,this.camera]},t.prototype._drawLayer=function(){e.prototype._drawLayer.apply(this,arguments),this.renderScene()},t.prototype.hitDetect=function(){return!1},t.prototype.createCanvas=function(){if(!this.canvas){var e=this.getMap().getSize(),t=u.Browser.retina?2:1,r=t*e.width,n=t*e.height;if(this.layer._canvas){var o=this.layer._canvas;o.width=r,o.height=n,o.style&&(o.style.width=e.width+"px",o.style.height=e.height+"px"),this.canvas=this.layer._canvas}else this.canvas=u.Canvas.createCanvas(r,n);this._initThreeRenderer(),this.onCanvasCreate(),this.layer.fire("canvascreate",{context:this.context,gl:this.gl})}},t.prototype._initThreeRenderer=function(){var e,t=this.getMap(),r=t.getSize(),n=this.layer.options.renderer;"gl"===n?((e=new l.WebGLRenderer(u.Util.extend({canvas:this.canvas,alpha:!0,preserveDrawingBuffer:!0},this.layer.options.glOptions))).autoClear=!1,e.clear()):"canvas"===n&&(e=new l.CanvasRenderer(u.Util.extend({canvas:this.canvas,alpha:!0},this.layer.options.glOptions))),e.setSize(this.canvas.width,this.canvas.height),e.setClearColor(new l.Color(1,1,1),0),e.canvas=this.canvas,this.context=e;var o=t.getScale(t.getMinZoom())/t.getScale(f(t))*r.height/2/this.layer._getFovRatio(),a=this.scene=new l.Scene,i=t.getFov(),s=this.camera=new l.PerspectiveCamera(i,r.width/r.height,1,o);a.add(s)},t.prototype.onCanvasCreate=function(){e.prototype.onCanvasCreate.call(this),this.layer.onCanvasCreate(this.context,this.scene,this.camera)},t.prototype.resizeCanvas=function(e){if(this.canvas){var t;t=e||this.getMap().getSize();var r=u.Browser.retina?2:1;this.canvas.height=r*t.height,this.canvas.width=r*t.width,this.camera.aspect=this.canvas.width/this.canvas.height,this.camera.updateProjectionMatrix(),this.context.setSize(this.canvas.width,this.canvas.height)}},t.prototype.clearCanvas=function(){this.canvas&&this.context.clear()},t.prototype.prepareCanvas=function(){return this.canvas?this.clearCanvas():this.createCanvas(),this.layer.fire("renderstart",{context:this.context}),null},t.prototype.renderScene=function(){this._locateCamera(),this.context.render(this.scene,this.camera),this.completeRender()},t.prototype.remove=function(){delete this._drawContext,e.prototype.remove.call(this)},t.prototype._locateCamera=function(){var e=this.getMap(),t=e.getSize(),r=e.getScale(),n=this.camera,o=e.coordinateToPoint(e.getCenter(),f(e)),a=e.getPitch()*p,i=e.getBearing()*p,s=this.layer._getFovRatio(),c=-r*t.height/2/s;n.position.z=c*Math.cos(a);var h=Math.sin(a)*c;n.position.x=o.x+h*Math.sin(i),n.position.y=o.y-h*Math.cos(i),n.up.set(Math.sin(i),-Math.cos(i),0),n.lookAt(new l.Vector3(o.x,o.y,0)),n.updateProjectionMatrix()},t}(u.renderer.CanvasLayerRenderer);function f(e){return e.getMaxNativeZoom()}t.registerRenderer("canvas",a),t.registerRenderer("gl",a),e.ThreeLayer=t,e.ThreeRenderer=a,Object.defineProperty(e,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.three v0.5.0, requires maptalks@>=0.36.2.")});